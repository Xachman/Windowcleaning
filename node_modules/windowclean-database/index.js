// db.js
// ========
var mysql      	= require('mysql');
var config      = require('windowclean-config');
var nw_gui 		= window.require('nw.gui');
var nw_window 	= nw_gui.Window.get();
var child 		= require('child_process');
var hasClosed 	= false;

nw_window.on('close', function() {
  if(hasClosed === false){
    hasClosed = true;
    var this_window = this;
    child.exec('cd ./mysql-5.6.27-winx64/bin & mysqladmin -u root shutdown', function (error, stdout, stderr) {
      console.log('stdout: ' + stdout);
      console.log('stderr: ' + stderr);
      if (error !== null) {
        console.log('exec error: ' + error);
      }else{
        this_window.close(true);
      }
  	});
  }else{
  	this.close(true);
  }
});

child.exec('cd ./mysql-5.6.27-winx64/bin & mysqld', function (error, stdout, stderr) {
    console.log('stdout: ' + stdout);
    console.log('stderr: ' + stderr);
    if (error !== null) {
      alert('Database failed to connect. Please restart the application.');
    }else{
    	db.connect();
      	db.dbConex = true;
    }
});

var db = mysql.createConnection({
  host     : config.db.host,
  user     : config.db.user,
  password : config.db.password,
  database : config.db.database
});



// db.queryDb = function(str) {

// };

exports.db = db;
