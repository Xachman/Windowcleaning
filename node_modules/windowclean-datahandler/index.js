// apidata.js
// ========
apidata = {};
apidata.getObjectsByKey = function(objarray, key, val) {
  var data = [];
  for(var i = 0; i < objarray.length; i++) {
    if(objarray[i][key] === val) {
      data.push(objarray[i]);
    }
  }
  return data;
};
apidata.getObjectsByDate = function(objarray, key, date) {
  var data = [];
  var sDate = new Date(date);
  sDate.setHours(0,0,0,0);
  var eDate = new Date(date);
  eDate.setHours(23,59,59,999);
  for(var i = 0; i < objarray.length; i++) {
    if(new Date(objarray[i][key]).getTime() >= sDate.getTime() && new Date(objarray[i][key]).getTime() <= eDate.getTime() ) {
      data.push(objarray[i]);
    }
  }
  return data;
};
apidata.getWeekDays = function(range){
  var days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Tursday', 'Firday', 'Saturday'];
  var data = range.data;
	var start = new Date(range.start);
	if(!('sDay' in range)) range.sDay = 0;
	start.setDate(start.getDate() - start.getDay() + range.sDay);
	var end = new Date(range.end);
  var addDays = 6 + range.sDay - 7;
	end.setDate(end.getDate() + ((end.getDay() === addDays )? 0 : 6 - end.getDay() + range.sDay));
	var cDay = start.getTime();
	var week = 0;
	var newWeek = true;
	var html = '';
	var colorDark = true;
	while(cDay <= end.getTime()){
		var date = new Date(cDay);
		var dateFormat = date.getMonth()+1+'/'+date.getDate()+'/'+date.getFullYear();
		cWeek = week;
		checkLastMonth = new Date(date);
		checkLastMonth.setDate(checkLastMonth.getDate() - 1);
		if(date.getMonth() !== checkLastMonth.getMonth()) {
			colorDark = (colorDark)? false : true;
		}
		if(newWeek === true) {
			lastWeekDate = new Date(date);
			lastWeekDate.setDate(lastWeekDate.getDate() + 6);
			var lastFromat = lastWeekDate.getMonth()+1+'/'+lastWeekDate.getDate()+'/'+lastWeekDate.getFullYear();
			html += '<div class="week" style="clear: both"><h3>Week of '+dateFormat+' - '+lastFromat+'</h3>';
		}
		newWeek = false;
    html += '<div class="day"><div class="day-hold">';
		html += '<h3 class="title">'+days[date.getDay()]+'</h3>';
		html += '<div class="date">'+dateFormat+'</div>';
    var jobs = apidata.getObjectsByDate(data, 'service_date', date);
    for(var i = 0; i < jobs.length; i++){
      job = jobs[i];
      html += '<div data-job="'+job.id+'" data-client="'+job.client_id+'" class="job-entry">'+job.job_name+': '+job.service_by+'</div>';
    }
		html += '</div></div>';
		var lastD = (addDays >= 0)? addDays : 6;
		if(date.getDay() === lastD) {
		html += '</div>';
		newWeek = true;
		week++;
		}
		date.setDate(date.getDate() + 1);
		cDay = date.getTime();
	}
	return html;
};

exports.apidata = apidata;
